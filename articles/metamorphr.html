<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>metamorphr • metamorphr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="metamorphr">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">metamorphr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/metamorphr.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/conjugate-screening.html">Conjugate Screening</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/yasche/metamorphr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>metamorphr</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/yasche/metamorphr/blob/master/vignettes/metamorphr.Rmd" class="external-link"><code>vignettes/metamorphr.Rmd</code></a></small>
      <div class="d-none name"><code>metamorphr.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/yasche/metamorphr" class="external-link">metamorphr</a></span><span class="op">)</span></span></code></pre></div>
<p>This vignette shows you how to work with metabolomics data using the
metamorphr package. It is intended as a quick overview and the choices
made (e.g., the algorithm for missing value imputation or normalization)
may not be the best for the specific data set.</p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Metabolomics data preparation usually involves several steps: Feature
tables are filtered to only contain ‘significant’ features, missing
values are imputed, intensities are normalized, and, depending on the
downstream analysis, data might also be scaled or transformed. The
metamorphr package was developed to make these steps more streamlined
and easier to perform. An example workflow is shown below. The goal of
the workflow is to create a volcano plot that compares cells treated
with the HMG-CoA reductase inhibitor mevastatin to cells treated with a
vehicle control.</p>
</div>
<div class="section level2">
<h2 id="the-whole-workflow">The whole workflow<a class="anchor" aria-label="anchor" href="#the-whole-workflow"></a>
</h2>
<p>For a quick reference, the workflow is shown as a whole below. The
individual steps are explained in detail further down.</p>
<p><em>The metamorphr package was developed to be used with a <a href="https://r4ds.hadley.nz/data-transform.html#sec-the-pipe" class="external-link">pipe
operator</a> and this vignette makes extensive use of it. Make sure that
you are familiar with the concept of the pipe before reading on. Also,
this vignette uses the <a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">magrittr
pipe</a> instead of the <a href="https://r4ds.hadley.nz/data-transform.html#sec-the-pipe" class="external-link">native
pipe</a> to make it compatible with older versions of R. You should be
able to use the native pipe as a drop-in replacement for the magrittr
pipe, if you wish.</em></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mevastatin_ft</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_featuretable.html">read_featuretable</a></span><span class="op">(</span></span>
<span>  <span class="st">"https://raw.githubusercontent.com/yasche/metamorphr-data/main/RP18/pos/MetaboScape/mevastatin/mevastatin.csv"</span>, </span>
<span>  label_col <span class="op">=</span> <span class="fl">3</span>, </span>
<span>  metadata_cols <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">15</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mevastatin_metadata</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span></span>
<span>  <span class="st">"https://raw.githubusercontent.com/yasche/metamorphr-data/main/RP18/pos/MetaboScape/mevastatin/mevastatin_metadata.csv"</span>, </span>
<span>  show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mevastatin_ft</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/join_metadata.html">join_metadata</a></span><span class="op">(</span><span class="va">mevastatin_metadata</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/filter_grouped_mv.html">filter_grouped_mv</a></span><span class="op">(</span>min_found <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>                    group_column <span class="op">=</span> <span class="va">Group</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/filter_blank.html">filter_blank</a></span><span class="op">(</span>blank_samples <span class="op">=</span> <span class="st">"blank"</span>, </span>
<span>               blank_as_group <span class="op">=</span> <span class="cn">T</span>,</span>
<span>               group_column <span class="op">=</span> <span class="va">Group</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/filter_cv.html">filter_cv</a></span><span class="op">(</span>reference_samples <span class="op">=</span> <span class="st">"QC"</span>,</span>
<span>            ref_as_group <span class="op">=</span> <span class="cn">T</span>,</span>
<span>            group_column <span class="op">=</span> <span class="va">Group</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Group</span> <span class="op">!=</span> <span class="st">"blank"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/impute_knn.html">impute_knn</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/normalize_quantile_smooth.html">normalize_quantile_smooth</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/collapse_mean.html">collapse_mean</a></span><span class="op">(</span>sample_metadata_cols <span class="op">=</span> <span class="st">"Group"</span>,</span>
<span>                feature_metadata_cols <span class="op">=</span> <span class="st">"Feature"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/plot_volcano.html">plot_volcano</a></span><span class="op">(</span>group_column <span class="op">=</span> <span class="va">Group</span>,</span>
<span>               name_column <span class="op">=</span> <span class="va">Feature</span>, </span>
<span>               groups_to_compare <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"control"</span>, <span class="st">"mevastatin"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="fl">0.05</span><span class="op">)</span>,</span>
<span>                        color <span class="op">=</span> <span class="st">"grey40"</span>,</span>
<span>                        linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span> <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                        color <span class="op">=</span> <span class="st">"grey40"</span>,</span>
<span>                        linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="metamorphr_files/figure-html/whole-thing-1.png" class="r-plt" alt="" width="700"></p>
</div>
<div class="section level2">
<h2 id="read-the-required-files">Read the required files<a class="anchor" aria-label="anchor" href="#read-the-required-files"></a>
</h2>
<p>This vignette uses data from a separate <a href="https://github.com/yasche/metamorphr-data" class="external-link">GitHub repository</a>.
More information about the data can be found there.</p>
<div class="section level3">
<h3 id="read-the-feature-table">Read the feature table<a class="anchor" aria-label="anchor" href="#read-the-feature-table"></a>
</h3>
<p>The first step in the workflow is to read a feature table. The
metamorphr package contains a convenience function,
<code>read_featuretable</code>, that reads files containing delimiter
separated values, for example files in the csv format, and performs
several initial tidying steps to bring them in the correct format.
<code>read_featuretable</code> can read files from disk but also literal
data and data from the internet. We use the latter to download data from
a <a href="https://github.com/yasche/metamorphr-data" class="external-link">GitHub
repository</a>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mevastatin_ft</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_featuretable.html">read_featuretable</a></span><span class="op">(</span></span>
<span>  <span class="st">"https://raw.githubusercontent.com/yasche/metamorphr-data/main/RP18/pos/MetaboScape/mevastatin/mevastatin.csv"</span>, </span>
<span>  label_col <span class="op">=</span> <span class="fl">3</span>, </span>
<span>  metadata_cols <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">15</span><span class="op">)</span></span></code></pre></div>
<p>With the <code>label_col</code> argument, we specify that the values
in column 3 in <a href="https://github.com/yasche/metamorphr-data/blob/main/RP18/pos/MetaboScape/mevastatin/mevastatin.csv" class="external-link">mevastatin.csv</a>
are used as feature labels (in this case the exact mass). Those values
are stored in a column named <code>Feature</code>. Further, with the
<code>metadata_cols</code> argument we specify that columns 1 to 15
contain feature metadata, for example retention time and collision cross
section (CCS). Those are preserved but it is important to tell
<code>read_featuretable</code> which columns contain metadata so the
parsing and initial tidying work as expected.</p>
<p>In addition to the <code>Feature</code> column and the preserved
metadata columns, several other columns are created automatically by
<code>read_featuretable</code>:</p>
<ul>
<li><p><code>UID</code>: a column containing a unique identifier for
each feature</p></li>
<li><p><code>Sample</code>: a column containing the sample
names</p></li>
<li><p><code>Intensity</code>: the measured intensity (or area) for a
specific <code>Sample</code> <code>Feature</code> combination.</p></li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">mevastatin_ft</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 18</span></span></span>
<span><span class="co">#&gt;     UID Feature    Sample           Intensity FEATURE_ID    RT   CCS SIGMA_SCORE</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1 186.015    QC_1_07-Aug-24_…      745.          1  13.6  133.          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     2 837.83232  QC_1_07-Aug-24_…     <span style="text-decoration: underline;">1</span>256.          2  24.5  152.          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     3 1403.71298 QC_1_07-Aug-24_…       <span style="color: #BB0000;">NA</span>           3  24.7  341.          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     4 769.84309  QC_1_07-Aug-24_…     <span style="text-decoration: underline;">3</span>594.          4  24.8  222.          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>     5 1539.68908 QC_1_07-Aug-24_…       <span style="color: #BB0000;">NA</span>           5  24.9  354.          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>     6 218.07551  QC_1_07-Aug-24_…       <span style="color: #BB0000;">NA</span>           6  26.0  151.          <span style="color: #BB0000;">NA</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 10 more variables: NAME_METABOSCAPE &lt;chr&gt;, MOLECULAR_FORMULA &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ADDUCT &lt;chr&gt;, KEGG &lt;chr&gt;, CAS &lt;chr&gt;, MaxIntensity &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   Condition_QC_MeanIntensity &lt;dbl&gt;, Condition_BLANK_MeanIntensity &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   Condition_Control_MeanIntensity &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   Condition_Treatment_MeanIntensity &lt;dbl&gt;</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="read-the-sample-metadata">Read the sample metadata<a class="anchor" aria-label="anchor" href="#read-the-sample-metadata"></a>
</h3>
<p>Sample metadata, for example group information or replicate number,
is required for some of the functions. An empty metadata table with
required columns and rows can be created from an existing feature table
via <code>create_metadata_skeleton</code> and exported and edited by
hand, for example in Microsoft Excel. After editing, the file can be
read back into R using <code><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">readr::read_csv</a></code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mevastatin_ft</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/create_metadata_skeleton.html">create_metadata_skeleton</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_csv</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"some/path/menadione_metadata.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mevastatin_metadata</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"some/path/menadione_metadata.csv"</span><span class="op">)</span></span></code></pre></div>
<p>In this case, there is already a file containing the relevant
metadata in the GitHub repository.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mevastatin_metadata</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span></span>
<span>  <span class="st">"https://raw.githubusercontent.com/yasche/metamorphr-data/main/RP18/pos/MetaboScape/mevastatin/mevastatin_metadata.csv"</span>, </span>
<span>  show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">mevastatin_metadata</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 5</span></span></span>
<span><span class="co">#&gt;   Sample                    Group      Replicate Batch Factor</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> B9_Comp_1_08-Aug-24_10235 mevastatin         1     1      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> B9_Comp_1_10-Aug-24_10378 mevastatin         1     1      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> B9_Comp_1_11-Aug-24_10517 mevastatin         1     1      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> B9_Comp_2_08-Aug-24_10236 mevastatin         2     1      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> B9_Comp_2_10-Aug-24_10379 mevastatin         2     1      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> B9_Comp_2_12-Aug-24_10522 mevastatin         2     1      1</span></span></code></pre></div>
<p>The metadata table must include the following columns:</p>
<ul>
<li><p><code>Sample</code>: Contains the sample names.</p></li>
<li><p><code>Group</code>: Contains group information.</p></li>
<li><p><code>Replicate</code>: Replicate information. If multiple
replicates of the same sample exist (e.g., the same sample was injected
multiple times) they must have the same replicate number.</p></li>
<li><p><code>Batch</code>: Samples belonging to the same batch must have
the same batch number.</p></li>
<li><p><code>Factor</code>: A sample specific factor, for example
protein concentration or dry weight. Only necessary for specific
normalization strategies.</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="join-them-together">Join them together<a class="anchor" aria-label="anchor" href="#join-them-together"></a>
</h3>
<p>metamorphr provides a convenience function,
<code>join_metadata</code>, for joining together a feature table and
associated metadata.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mevastatin_ft</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/join_metadata.html">join_metadata</a></span><span class="op">(</span><span class="va">mevastatin_ft</span>, <span class="va">mevastatin_metadata</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="filter">Filter<a class="anchor" aria-label="anchor" href="#filter"></a>
</h2>
<p>In this workflow, filter functions are used to improve the overall
data quality. In the R console, you can type
<code><a href="https://dplyr.tidyverse.org/reference/defunct-lazyeval.html" class="external-link">metamorphr::filter_</a></code> to see all available filter functions.
<code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">dplyr::filter</a></code> is used to remove blank samples
afterwards.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mevastatin_ft</span> <span class="op">&lt;-</span> <span class="va">mevastatin_ft</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/filter_grouped_mv.html">filter_grouped_mv</a></span><span class="op">(</span>min_found <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>                    group_column <span class="op">=</span> <span class="va">Group</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/filter_blank.html">filter_blank</a></span><span class="op">(</span>blank_samples <span class="op">=</span> <span class="st">"blank"</span>, </span>
<span>               blank_as_group <span class="op">=</span> <span class="cn">T</span>,</span>
<span>               group_column <span class="op">=</span> <span class="va">Group</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/filter_cv.html">filter_cv</a></span><span class="op">(</span>reference_samples <span class="op">=</span> <span class="st">"QC"</span>,</span>
<span>            ref_as_group <span class="op">=</span> <span class="cn">T</span>,</span>
<span>            group_column <span class="op">=</span> <span class="va">Group</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Group</span> <span class="op">!=</span> <span class="st">"blank"</span><span class="op">)</span></span></code></pre></div>
<p>In this workflow, 3 filter functions are used sequentially:</p>
<ul>
<li><p><code>filter_grouped_mv</code>: To only keep features with a low
rate of missing values. With default parameters, only features are kept
if they were found in at least 75 % of the samples of at least 1
group.</p></li>
<li><p><code>filter_blank</code>: To remove features that were found
with a high intensity in blank samples. With default parameters, only
features are kept were the maximum intensity in non-blank samples is at
least 3 times as high as in blank samples.</p></li>
<li><p><code>filter_cv</code>: To remove features with a poor
reproducibility (i.e., with a high coefficient of variation, CV) in
quality control samples. With the default parameters, only features with
a maximum CV of 0.2 are kept.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="imputate-missing-values">Imputate missing values<a class="anchor" aria-label="anchor" href="#imputate-missing-values"></a>
</h2>
<p>The data contains missing values (i.e., <code>NA</code>). Those
should be imputed prior to creating a volcano plot. For this example,
the <a href="https://en.wikipedia.org/wiki/K-nearest_neighbors_algorithm" class="external-link"><em>k</em>-nearest
neighbors algorithm</a> is used for imputation but the metamorphr
package provides other options as well. Start typing
<code>metamorphr::impute_</code> in the R console to see the available
options.</p>
<p>The underlying design of the metamorphr package makes it very easy to
visualize the data using ‘ggplot2’. Below, a simple visualization is
used to verify that the imputation worked as expected.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mevastatin_ft_before_impute</span> <span class="op">&lt;-</span> <span class="va">mevastatin_ft</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>State <span class="op">=</span> <span class="st">"Before imputation"</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">mevastatin_ft</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/impute_knn.html">impute_knn</a></span><span class="op">(</span><span class="va">mevastatin_ft</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mevastatin_ft</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>State <span class="op">=</span> <span class="st">"After imputation"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">mevastatin_ft_before_impute</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>State <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">State</span>, </span>
<span>                               levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Before imputation"</span>, </span>
<span>                                          <span class="st">"After imputation"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">State</span>, <span class="va">Sample</span>, <span class="va">Group</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span>wt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Intensity</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">Sample</span>, <span class="va">n</span>, color <span class="op">=</span> <span class="va">Group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">State</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Number of missing values"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                   legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="metamorphr_files/figure-html/viz-impute-1.png" class="r-plt" alt="" width="700"></p>
<p>As expected, there are no missing values after imputation.</p>
</div>
<div class="section level2">
<h2 id="normalize">Normalize<a class="anchor" aria-label="anchor" href="#normalize"></a>
</h2>
<p>Next, intensities are normalized across samples. In this example, a
smooth quantile normalization is used (Hicks et al., 2018). This
algorithm requires sample metadata, more specifically, grouping
information. Other available options can be viewed by typing
<code>metamorphr::normalize_</code> into the R console.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mevastatin_ft_before_norm</span> <span class="op">&lt;-</span> <span class="va">mevastatin_ft</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>State <span class="op">=</span> <span class="st">"Before normalization"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mevastatin_ft</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/normalize_quantile_smooth.html">normalize_quantile_smooth</a></span><span class="op">(</span><span class="va">mevastatin_ft</span><span class="op">)</span></span></code></pre></div>
<p>Again, we can use a ‘ggplot2’ visualization as verification.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mevastatin_ft</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>State <span class="op">=</span> <span class="st">"After normalization"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">mevastatin_ft_before_norm</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>State <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">State</span>, </span>
<span>                               levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Before normalization"</span>, </span>
<span>                                          <span class="st">"After normalization"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">Sample</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">Intensity</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">Group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">State</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"log10(Intensity)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                   legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="metamorphr_files/figure-html/viz-norm-1.png" class="r-plt" alt="" width="700"></p>
<p>The normalization worked as expected. The distributions of
intensities inside each group are identical.</p>
</div>
<div class="section level2">
<h2 id="collapse-technical-replicates">Collapse technical replicates<a class="anchor" aria-label="anchor" href="#collapse-technical-replicates"></a>
</h2>
<p>In the example data set, the same sample was injected 3 times. Prior
to doing statistics and drawing the volcano plot, those technical
replicates should be collapsed. The metamorphr package provides several
approaches to do this. Start typing <code>metamorphr::collapse_</code>
into the R console to see the available options. For this workflow, we
will simply calculate the mean of the technical replicates using
<code>collapse_mean</code>. It is important that sample metadata are
provided for this approach.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mevastatin_metadata</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 73 × 5</span></span></span>
<span><span class="co">#&gt;    Sample                    Group      Replicate Batch Factor</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> B9_Comp_1_08-Aug-24_10235 mevastatin         1     1      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> B9_Comp_1_10-Aug-24_10378 mevastatin         1     1      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> B9_Comp_1_11-Aug-24_10517 mevastatin         1     1      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> B9_Comp_2_08-Aug-24_10236 mevastatin         2     1      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> B9_Comp_2_10-Aug-24_10379 mevastatin         2     1      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> B9_Comp_2_12-Aug-24_10522 mevastatin         2     1      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> B9_Comp_3_08-Aug-24_10237 mevastatin         3     1      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> B9_Comp_3_10-Aug-24_10380 mevastatin         3     1      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> B9_Comp_3_12-Aug-24_10523 mevastatin         3     1      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> B9_Comp_4_08-Aug-24_10238 mevastatin         4     1      1</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 63 more rows</span></span></span></code></pre></div>
<p>It is important that <code>Group</code> and <code>Replicate</code>
information is provided as well as <code>Batch</code>. Technical
replicates of the same sample must have the same value for
<code>Group</code>, <code>Batch</code> and <code>Replicate</code>. For
example, <code>B9_Comp_1...</code> belongs to group
<code>mevastatin</code> and was injected 3 times as indicated by the
three samples with replicate number 1.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mevastatin_ft</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/collapse_mean.html">collapse_mean</a></span><span class="op">(</span><span class="va">mevastatin_ft</span>,</span>
<span>                               sample_metadata_cols <span class="op">=</span> <span class="st">"Group"</span>,</span>
<span>                               feature_metadata_cols <span class="op">=</span> <span class="st">"Feature"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="plot">Plot<a class="anchor" aria-label="anchor" href="#plot"></a>
</h2>
<p>Finally, data can be plotted with <code>plot_volcano</code>. The
resulting plot can be easily modified with ‘ggplot2’ functions.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_volcano.html">plot_volcano</a></span><span class="op">(</span><span class="va">mevastatin_ft</span>,</span>
<span>             group_column <span class="op">=</span> <span class="va">Group</span>,</span>
<span>             name_column <span class="op">=</span> <span class="va">Feature</span>, </span>
<span>             groups_to_compare <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"control"</span>, <span class="st">"mevastatin"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="fl">0.05</span><span class="op">)</span>,</span>
<span>                      color <span class="op">=</span> <span class="st">"grey40"</span>,</span>
<span>                      linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span> <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                      color <span class="op">=</span> <span class="st">"grey40"</span>,</span>
<span>                      linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="metamorphr_files/figure-html/plot-volc-1.png" class="r-plt" alt="" width="700"></p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Hicks, S. C., Okrah, K., Paulson, J. N., Quackenbush, J., Irizarry,
R. A., &amp; Bravo, H. C. (2018). Smooth quantile normalization.
<em>Biostatistics, 19</em>(2), 185–198. DOI
10.1093/biostatistics/kxx028</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Yannik Schermer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
